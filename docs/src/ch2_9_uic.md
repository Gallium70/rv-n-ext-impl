# 用户态中断控制器

注：本文档目前为草稿，内容随时可能变化。

## 背景

N 扩展为用户态中断提供了基本支持，但对于跨核、跨进程中断，仍然需要由内核软件代为转发。本设计希望提供一种机制，使得软件到用户态软件之间的中断过程可以尽可能少地经过内核。

## 设计思路

在控制器中，每个发送方和接收方各自有一定数量的发送和接收槽位，二者的映射关系通常由内核维护，并写入控制器中。

发送槽位中的内容为接收方标识符和接收槽位编号，接收槽位仅有一位，表示该槽位是否有中断。
发送中断时，发送方选择一个发送槽位，若该槽位中的映射有效，则将相应接收槽位置为一。
接收方可以独立地屏蔽每一个接收槽位，并通过领取(claim)读出非零的槽位编号，并将相应槽位清零。接收槽位编号与发送方的关系由软件维护。

内核维护接收方和硬件线程的映射关系，若某个接收方对应了一个硬件线程，且该接收方未屏蔽的槽位中有非零项，则相应硬件线程的 `mip.MSIP` 位被置一。

一个特定的控制器中发送方、接收方、发送槽位和接收槽位的数量可能都是受限的，对于超出该数量的中断需求，可由软件实现额外的复用机制。
