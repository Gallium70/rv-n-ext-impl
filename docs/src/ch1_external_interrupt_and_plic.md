# 外部中断与平台级中断控制器（PLIC）

## 外部中断

外部中断主要用于处理与外设相关的中断，如 GPIO、UART、DMA 等。PLIC 接收所有外设的中断信号，根据程序配置的优先级、阈值和上下文规则，在相应的核上触发外部中断。程序需要从 PLIC 的 MMIO 寄存器中进一步读取具体的中断外设源信息。

`mip.MEIP` 位对程序是只读的，只能由 PLIC 写入或清除。 `mip.SEIP` 可读写， M 态程序可以将该位置 1 ，而是否产生 S 态外部中断由该位的值和 PLIC 相应的信号逻辑或的结果决定，二者中任一为 1 即产生中断； `csrr` 、 `csrrs` 和 `csrrc` 指令在该位上的行为略有不同，具体可见规范。 `sip.SEIP` （对 S 态程序）是只读的。对于用户态中断可以设计类似的约束条件。

## PLIC

目前的 [PLIC 规范](https://github.com/riscv/riscv-plic-spec/blob/master/riscv-plic.adoc) 支持至多 1024 个（外设）中断源和 15872 套上下文（具体含义将在下文分析），每个中断源可配置 2^32 种优先级，每套上下文可配置 2^32 种优先级阈值，以及在每套上下文中可配置每个中断源是否使能。

### 中断触发条件

1. 中断源产生中断等待信号；
2. 在某套上下文中，该中断源被使能；
3. 该中断源的优先级高于该上下文的优先级阈值；

上述条件均满足时，PLIC 会在核中触发外部中断，核编号与中断的特权级由上下文的设计决定。

### 上下文

规范中并未给出 “上下文” 的具体定义，但在[一个 Issue 中有人提到](https://github.com/riscv/riscv-plic-spec/issues/10#issuecomment-641632618)，在实践中一套上下文通常指代每个核心和特权级的组合，如果 CPU 中有三个核和两个可以处理中断的特权级（ M 和 S ），那么就存在六套 PLIC 上下文（在某个核上触发某个特权级的外部中断）。在该场景下，不妨按以下方法对上下文编号：

|             | 核心 1   | 核心 2   | 核心 3   |
| ----------- | -------- | -------- | -------- |
| 运行在 M 态 | 上下文 1 | 上下文 2 | 上下文 3 |
| 运行在 S 态 | 上下文 4 | 上下文 5 | 上下文 6 |

设某个中断源在上下文 1 和 6 中符合中断触发条件，那么当核心 1 运行在 M 态时，PLIC 会在核心 1 上触发 MEI ；核心 3 运行在 S 态时，会在核心 3 上触发 SEI ；在其他特权级，以及核心 2 上，该中断源不会触发外部中断。

### 中断领取与完成

PLIC 中每套上下文具有一个领取/完成（`claim/complete`）寄存器。程序读取该寄存器时，PLIC 会返回该上下文中优先级最高、等待信号有效且被使能的中断源编号（该中断源的优先级可以低于上下文阈值），同时 清除该中断源的等待位，并屏蔽其信号。程序向该寄存器中写入一个中断编号以通知 PLIC 该中断处理完成，若相应中断源在其上下文中被使能，则 PLIC 解除相应的屏蔽，否则忽略本次写入。
